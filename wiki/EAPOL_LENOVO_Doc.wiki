#labels Phase-Design,EAPOL
=深入了解校园网802.1x认证的EAP协议(3)——联想802.1x认证细节=

原文: http://apt-blog.net/archives/423.html

联想的认证协议是我写的这几个802.1x实现里面相对简单的版本，没有太多古古怪怪的信息头信息尾部。

我们学校并没有使用过联想协议的认证系统，而是受了一位网友的邀请才写的，所以我连联想官方客户端的样子都没看到过，一直是由那网友抓包后发送过来，而我猜测地将其套入到此前我写的神州数码的认证程序里面，经过几天的调试，确实能用，虽然并不完全了解认证报文的每个细节。

PT实现的联想Linux客户端项目主页：http://code.google.com/p/zlevoclient/

以下的说明是基于EAP协议过程的补充描述，如果不清楚EAP，可先读深入了解校园网802.1x认证的EAP协议(1)——EAP的总体流程。

认证过程报文的细节描述：

   1. EAPOL-Start、EAPOL-Logoff
      设置长度为0的协议包头，然后紧接6个意义不明的字节（可能是版本号之类），直接复制即可，这个数组：
       `{0x00, 0x00, 0x2f, 0xfc, 0x03, 0x00};`

   2. EAP-RESPONSE-Identity
      长度为5（头部） + username_length，无特别，跟EAP标准一致，

   3. EAP-RESPONSE-MD5_Challenge
      长度为6（头部） + 16（MD5值） + username_length，在MD5值之后，先紧接用户名，然后是4字节的本机IP地址，以及9个意义不明的字节，直接复制：{0x00, 0x00, 0x2f, 0xfc, 0x00, 0x03, 0x01, 0x01, 0x00};

   4. EAPOL-KEEP-ALIVE
      当认证成功后，需要每60秒发送一次该报文，否则会断线；
      该报文的b:EAPOL 报文类型为0xFC，帧长值为12，其携带信息的前8字节在实际中似乎是随机变化，找不出其规律，不过实际上全部设0也可；后4字节则是本机IP。

在部分版本中，如吉林大学珠海学院，每隔5分钟（可能就在第五个EAPOL-KEEP-ALIVE发出之后）服务器会重新发来EAP-REQUEST-Identity，程序需要正确应答，特别要设置各个应答报文中的e:EAP通信id。

关于服务器返回的数据包，Success和Failure通常包含有中文编码的信息，标志是，EAP报文结束后，紧接0x00002ffc（大概0x18、0x19），其后接着是一个字节的报文长度，再后就是gb2312编码的中文信息。

由于协助我测试的湖南人文科技学院的网友他们的系统是纯手工设置网卡IP的，所以我也不清楚是否有像其他品牌的协议那样有动态静态IP位之类的信息位，如果发现这个版本的程序不能通过认证，可以自己抓包分析，或邮件联系PT。